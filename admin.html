<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Jugan Waste Collection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .navbar { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card { background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .announcement-item, .suggestion-item, .user-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 10px; background: #f8f9fa; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html"><i class="bi bi-recycle"></i> Jugan Waste Collection</a>
            <div class="ms-auto d-flex align-items-center">
                <span class="badge bg-danger me-3">Admin Panel</span>
                <a class="btn btn-outline-danger btn-sm" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</a>
            </div>
        </div>
    </nav>
    <div class="container mt-5 pt-5">
        <h2 class="text-center text-white mb-4"><i class="bi bi-shield-check"></i> Admin Dashboard</h2>
        <div class="row">
            <div class="col-md-6">
                <div class="card p-4">
                    <h5 class="card-title"><i class="bi bi-plus-circle"></i> Create / Edit Announcement</h5>
                    <form id="announcementForm">
                        <input type="hidden" id="editIndex" value="-1">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="title" placeholder="Title" required>
                        </div>
                        <div class="mb-3">
                            <textarea class="form-control" id="content" rows="3" placeholder="Content" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger" id="submitBtn"><i class="bi bi-save"></i> Post Announcement</button>
                        <button type="button" class="btn btn-secondary ms-2" id="cancelBtn" style="display: none;" onclick="cancelEdit()">Cancel Edit</button>
                    </form>
                </div>
                <div class="card p-4">
                    <h5 class="card-title"><i class="bi bi-list-check"></i> Existing Announcements</h5>
                    <div id="announcementsList"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-4">
                    <h5 class="card-title"><i class="bi bi-chat-quote"></i> Suggestions</h5>
                    <div id="suggestions"></div>
                </div>
                <div class="card p-4">
                    <h5 class="card-title"><i class="bi bi-people"></i> Manage Users</h5>
                    <div id="usersList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel"><i class="bi bi-pencil-square"></i> Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserIndex" value="-1">
                        <div class="mb-3">
                            <label for="editUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="editUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="editPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="editRole" class="form-label">Role</label>
                            <select class="form-control" id="editRole" required>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle"></i> Update User</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let announcements = JSON.parse(localStorage.getItem('announcements')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [];
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));

        function loadAnnouncements() {
            const container = document.getElementById('announcementsList');
            container.innerHTML = announcements.map((a, index) => `
                <div class="announcement-item">
                    <h6>${a.title}</h6>
                    <p>${a.content}</p>
                    <button class="btn btn-warning btn-sm" onclick="editAnnouncement(${index})"><i class="bi bi-pencil"></i> Edit</button>
                    <button class="btn btn-danger btn-sm ms-2" onclick="deleteAnnouncement(${index})"><i class="bi bi-trash"></i> Delete</button>
                </div>
            `).join('');
        }

        function editAnnouncement(index) {
            const announcement = announcements[index];
            document.getElementById('title').value = announcement.title;
            document.getElementById('content').value = announcement.content;
            document.getElementById('editIndex').value = index;
            document.getElementById('submitBtn').innerHTML = '<i class="bi bi-arrow-repeat"></i> Update Announcement';
            document.getElementById('cancelBtn').style.display = 'inline-block';
        }

        function deleteAnnouncement(index) {
            if (confirm('Are you sure you want to delete this announcement?')) {
                announcements.splice(index, 1);
                localStorage.setItem('announcements', JSON.stringify(announcements));
                loadAnnouncements();
            }
        }

        function cancelEdit() {
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
            document.getElementById('editIndex').value = '-1';
            document.getElementById('submitBtn').innerHTML = '<i class="bi bi-save"></i> Post Announcement';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        document.getElementById('announcementForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const editIndex = parseInt(document.getElementById('editIndex').value);

            if (editIndex >= 0) {
                announcements[editIndex] = { title, content };
                alert('Announcement updated!');
            } else {
                announcements.push({ title, content });
                alert('Announcement posted!');
            }

            localStorage.setItem('announcements', JSON.stringify(announcements));
            cancelEdit();
            loadAnnouncements();
        });

        function loadSuggestions() {
            const suggestions = JSON.parse(localStorage.getItem('suggestions')) || [];
            const container = document.getElementById('suggestions');
            container.innerHTML = suggestions.map(s => `
                <div class="suggestion-item">
                    <p><strong>${s.username}:</strong> ${s.suggestion}</p>
                </div>
            `).join('');
        }

        function loadUsers() {
            const container = document.getElementById('usersList');
            container.innerHTML = users.map((u, index) => `
                <div class="user-item d-flex justify-content-between align-items-center">
                    <div><strong>${u.username}</strong> (${u.role})</div>
                    <div>
                        <button class="btn btn-warning btn-sm" onclick="editUser(${index})" ${u.username === currentUser.username ? 'disabled' : ''}><i class="bi bi-pencil"></i> Edit</button>
                        <button class="btn btn-danger btn-sm ms-2" onclick="deleteUser(${index})" ${u.username === currentUser.username || (u.role === 'admin' && users.filter(user => user.role === 'admin').length === 1) ? 'disabled' : ''}><i class="bi bi-trash"></i> Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function editUser(index) {
            const user = users[index];
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editPassword').value = user.password;
            document.getElementById('editRole').value = user.role;
            document.getElementById('editUserIndex').value = index;
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }

        function deleteUser(index) {
            const user = users[index];
            if (user.username === currentUser.username) {
                alert('You cannot delete yourself!');
                return;
            }
            if (user.role === 'admin' && users.filter(u => u.role === 'admin').length === 1) {
                alert('Cannot delete the last admin!');
                return;
            }
            if (confirm(`Are you sure you want to delete user "${user.username}"?`)) {
                users.splice(index, 1);
                localStorage.setItem('users', JSON.stringify(users));
                loadUsers();
            }
        }

        document.getElementById('editUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const index = parseInt(document.getElementById('editUserIndex').value);
            const username = document.getElementById('editUsername').value;
            const password = document.getElementById('editPassword').value;
            const role = document.getElementById('editRole').value;

            if (users.find((u, i) => u.username === username && i !== index)) {
                alert('Username already exists!');
                return;
            }

            users[index] = { username, password, role };
            localStorage.setItem('users', JSON.stringify(users));
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
            loadUsers();
            alert('User updated!');
        });

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        loadAnnouncements();
        loadSuggestions();
        loadUsers();
       
        fetch('/cgi-bin/cgi_script', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'action=login&username=' + username + '&password=' + password
}).then(res => res.json()).then(data => {
    if (data.success) {
        localStorage.setItem('currentUser', JSON.stringify(data.user));
        // Redirect based on role
    } else {
        alert(data.message);
    }
});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>